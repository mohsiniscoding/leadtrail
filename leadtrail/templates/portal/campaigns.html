{% extends "base.html" %}
{% load i18n %}

{% block title %}
  Campaigns - LeadTrail
{% endblock title %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <!-- Header with Create Campaign Button -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Campaigns</h1>
    <a href="{% url 'portal:campaign_create' %}" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors no-underline">
      <span class="mr-2">Create Campaign</span>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
      </svg>
    </a>
  </div>

  <!-- Campaigns List -->
  <div class="space-y-6">
    {% if campaigns %}
      {% for campaign in campaigns %}
      <!-- Full Width Campaign Card -->
      <div class="bg-white shadow-md rounded-lg p-8 hover:shadow-lg transition-shadow">
        <!-- Campaign Header -->
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-xl font-medium text-gray-900">{{ campaign.name }}</h2>
            <p class="text-sm text-gray-500">{{ campaign.company_numbers.count }} companies • Created {{ campaign.created_at|date:"F j, Y" }}</p>
          </div>
          <div class="flex space-x-2">
            <button class="inline-flex items-center px-3 py-2 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 transition-colors">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Full Export
            </button>
            <button onclick="showDeleteModal('{{ campaign.id }}', '{{ campaign.name }}', '{{ campaign.company_numbers.count }}')" class="inline-flex items-center px-3 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
              Delete
            </button>
          </div>
        </div>

        <!-- Processing Pipeline -->
        <div class="space-y-4">
          <!-- Step 1: Companies House Lookup -->
          <div class="bg-gray-50 rounded-lg p-6 border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <!-- Step Number -->
                <div class="flex items-center justify-center w-8 h-8 bg-blue-500 text-white text-sm font-bold rounded-full">
                  1
                </div>
                
                <!-- Circular Progress -->
                <div class="relative w-16 h-16">
                  <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 32 32">
                    <circle cx="16" cy="16" r="14" stroke="#e5e7eb" stroke-width="2" fill="none"/>
                    <circle cx="16" cy="16" r="14" stroke="#10b981" stroke-width="2" fill="none"
                            stroke-dasharray="{{campaign.house_data_progress}} 100"
                            stroke-linecap="round"/>
                  </svg>
                  <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-sm font-semibold text-gray-700">{{campaign.house_data_progress}}%</span>
                  </div>
                </div>
                
                <!-- Content -->
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <h3 class="text-lg font-medium text-gray-900">Companies House Lookup</h3>
                    <div class="relative group">
                      <svg class="w-4 h-4 text-blue-500 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                      </svg>
                      <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                        Fetches official company information from the UK Companies House database including company name, status, officers, and registration details.
                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                      </div>
                    </div>
                  </div>
                  <p class="text-sm text-gray-600 mb-2">
                    {% with stats=campaign.house_data_stats %}
                      {{ stats.completed_lookups }}/{{ stats.total_companies }} processed • {{ stats.success_rate }}% success rate
                    {% endwith %}
                  </p>
                  <div class="flex space-x-4 text-xs text-gray-500">
                    {% with stats=campaign.house_data_stats %}
                      <div class="relative group">
                        <span class="cursor-help">✓ {{ stats.successful_lookups }} successful</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                          {{ stats.successful_lookups }} out of {{ stats.completed_lookups }} Companies House lookups returned valid company data with SUCCESS status
                          <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                        </div>
                      </div>
                      {% if stats.total_companies > stats.completed_lookups %}
                        <div class="relative group">
                          <span class="cursor-help">⏳ {{ stats.total_companies|add:"-"|add:stats.completed_lookups }} pending</span>
                          <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                            {{ stats.total_companies|add:"-"|add:stats.completed_lookups }} companies are waiting to be processed by the Companies House lookup worker
                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                          </div>
                        </div>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              </div>
              
              <!-- Export Button -->
              <a href="{% url 'portal:export_companies_house_csv' campaign.id %}" 
                 class="inline-flex items-center px-3 py-1 bg-white border border-gray-300 text-gray-700 text-xs rounded hover:bg-gray-50 transition-colors">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Export
              </a>
            </div>
          </div>

          <!-- Step 2: VAT Lookup -->
          <div class="bg-gray-50 rounded-lg p-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <!-- Step Number -->
                <div class="flex items-center justify-center w-8 h-8 bg-green-500 text-white text-sm font-bold rounded-full">
                  2
                </div>
                
                <!-- Circular Progress -->
                <div class="relative w-16 h-16">
                  <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 32 32">
                    <circle cx="16" cy="16" r="14" stroke="#e5e7eb" stroke-width="2" fill="none"/>
                    <circle cx="16" cy="16" r="14" stroke="#10b981" stroke-width="2" fill="none"
                            stroke-dasharray="{{campaign.vat_lookup_progress}} 100"
                            stroke-linecap="round"/>
                  </svg>
                  <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-sm font-semibold text-gray-700">{{campaign.vat_lookup_progress}}%</span>
                  </div>
                </div>
                
                <!-- Content -->
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <h3 class="text-lg font-medium text-gray-900">VAT Lookup</h3>
                    <div class="relative group">
                      <svg class="w-4 h-4 text-blue-500 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                      </svg>
                      <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                        Searches for VAT registration numbers and validates company tax information to enhance lead data quality.
                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                      </div>
                    </div>
                  </div>
                  <p class="text-sm text-gray-600 mb-2">
                    {% with stats=campaign.vat_lookup_stats %}
                      {{ stats.completed_lookups }}/{{ stats.total_companies }} processed • {{ stats.success_rate }}% success rate
                    {% endwith %}
                  </p>
                  <div class="flex space-x-4 text-xs text-gray-500">
                    {% with stats=campaign.vat_lookup_stats %}
                      <div class="relative group">
                        <span class="cursor-help">✓ {{ stats.successful_lookups }} VAT numbers found</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                          {{ stats.successful_lookups }} out of {{ stats.completed_lookups }} VAT lookups returned valid VAT registration numbers
                          <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                        </div>
                      </div>
                      {% if stats.total_companies > stats.completed_lookups %}
                        <div class="relative group">
                          <span class="cursor-help">⏳ {{ stats.total_companies|add:"-"|add:stats.completed_lookups }} pending</span>
                          <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                            {{ stats.total_companies|add:"-"|add:stats.completed_lookups }} companies are waiting to be processed by the VAT lookup worker
                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                          </div>
                        </div>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              </div>
              
              <!-- Export Button -->
              <a href="{% url 'portal:export_vat_lookup_csv' campaign.id %}" 
                 class="inline-flex items-center px-3 py-1 bg-white border border-gray-300 text-gray-700 text-xs rounded hover:bg-gray-50 transition-colors">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Export
              </a>
            </div>
          </div>
          <!-- Step 3: Website Hunting -->
          <div class="bg-gray-50 rounded-lg p-6 border-l-4 border-purple-500">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <!-- Step Number -->
                <div class="flex items-center justify-center w-8 h-8 bg-purple-500 text-white text-sm font-bold rounded-full">
                  3
                </div>
                
                <!-- Circular Progress -->
                <div class="relative w-16 h-16">
                  <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 32 32">
                    <circle cx="16" cy="16" r="14" stroke="#e5e7eb" stroke-width="2" fill="none"/>
                    <circle cx="16" cy="16" r="14" stroke="#10b981" stroke-width="2" fill="none"
                            stroke-dasharray="{{campaign.website_hunting_progress}} 100"
                            stroke-linecap="round"/>
                  </svg>
                  <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-sm font-semibold text-gray-700">{{campaign.website_hunting_progress}}%</span>
                  </div>
                </div>
                
                <!-- Content -->
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <h3 class="text-lg font-medium text-gray-900">Website Hunting</h3>
                    <div class="relative group">
                      <svg class="w-4 h-4 text-blue-500 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                      </svg>
                      <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                        Uses ZenSERP API to find company websites by analyzing search results and ranking potential domains.
                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                      </div>
                    </div>
                  </div>
                  <p class="text-sm text-gray-600 mb-2">
                    {% with stats=campaign.website_hunting_stats %}
                      {{ stats.completed_lookups }}/{{ stats.total_companies }} processed • {{ stats.approved_domains }} approved
                    {% endwith %}
                  </p>
                  <div class="flex space-x-4 text-xs text-gray-500">
                    {% with stats=campaign.website_hunting_stats %}
                      <div class="relative group">
                        <span class="cursor-help">🎯 {{ stats.score_breakdown.non_zero.percentage }}% quality sites</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                          {{ stats.score_breakdown.non_zero.count }} out of {{ stats.completed_lookups }} companies have websites with quality scores above 0 (indicating good matches)
                          <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                        </div>
                      </div>
                      <div class="relative group">
                        <span class="cursor-help">⭐ {{ stats.score_breakdown.score_2.percentage }}% premium</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                          {{ stats.score_breakdown.score_2.count }} companies have websites with premium scores (2.0+), indicating high-confidence matches
                          <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                        </div>
                      </div>
                      {% if stats.total_companies > stats.completed_lookups %}
                        <span>⏳ {{ stats.total_companies|add:"-"|add:stats.completed_lookups }} pending</span>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              </div>
              
              <!-- Action Buttons -->
              <div class="flex space-x-2">
                <a href="{% url 'portal:website_human_review' campaign.id %}" class="inline-flex items-center px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors no-underline">
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                  </svg>
                  Perform Review & Approve
                </a>
                <a href="{% url 'portal:export_website_hunting_csv' campaign.id %}" 
                   class="inline-flex items-center px-3 py-1 bg-white border border-gray-300 text-gray-700 text-xs rounded hover:bg-gray-50 transition-colors">
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  Export
                </a>
              </div>
            </div>
          </div>

          <!-- Step 4: Website Contact Lookup -->
          <div class="bg-gray-50 rounded-lg p-6 border-l-4 border-indigo-500">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <!-- Step Number -->
                <div class="flex items-center justify-center w-8 h-8 bg-indigo-500 text-white text-sm font-bold rounded-full">
                  4
                </div>
                
                <!-- Circular Progress -->
                <div class="relative w-16 h-16">
                  <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 32 32">
                    <circle cx="16" cy="16" r="14" stroke="#e5e7eb" stroke-width="2" fill="none"/>
                    <circle cx="16" cy="16" r="14" stroke="#10b981" stroke-width="2" fill="none"
                            stroke-dasharray="{{campaign.website_contact_lookup_progress}} 100"
                            stroke-linecap="round"/>
                  </svg>
                  <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-sm font-semibold text-gray-700">{{campaign.website_contact_lookup_progress}}%</span>
                  </div>
                </div>
                
                <!-- Content -->
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <h3 class="text-lg font-medium text-gray-900">Contact Extraction</h3>
                    <div class="relative group">
                      <svg class="w-4 h-4 text-blue-500 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                      </svg>
                      <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                        Crawls and extracts contact information (phone numbers, emails, social media) from approved company websites.
                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                      </div>
                    </div>
                  </div>
                  <p class="text-sm text-gray-600 mb-2">
                    {% with stats=campaign.website_contact_lookup_stats %}
                      {{ stats.completed_lookups }}/{{ stats.approved_domains }} approved sites processed
                    {% endwith %}
                  </p>
                  <div class="flex space-x-4 text-xs text-gray-500">
                    {% with stats=campaign.website_contact_lookup_stats %}
                      <div class="relative group">
                        <span class="cursor-help">📧 {{ stats.contact_breakdown.email_found.percentage }}% emails</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                          {{ stats.contact_breakdown.email_found.count }} out of {{ stats.approved_domains }} approved websites have at least one email address found
                          <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                        </div>
                      </div>
                      <div class="relative group">
                        <span class="cursor-help">📞 {{ stats.contact_breakdown.phone_found.percentage }}% phones</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                          {{ stats.contact_breakdown.phone_found.count }} out of {{ stats.approved_domains }} approved websites have at least one phone number found
                          <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                        </div>
                      </div>
                      <div class="relative group">
                        <span class="cursor-help">🔗 {{ stats.contact_breakdown.linkedin_found.percentage }}% social</span>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                          {{ stats.contact_breakdown.linkedin_found.count }} out of {{ stats.approved_domains }} approved websites have LinkedIn or other social media links found
                          <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                        </div>
                      </div>
                    {% endwith %}
                  </div>
                </div>
              </div>
              
              <!-- Export Button -->
              <a href="{% url 'portal:export_contact_extraction_csv' campaign.id %}" 
                 class="inline-flex items-center px-3 py-1 bg-white border border-gray-300 text-gray-700 text-xs rounded hover:bg-gray-50 transition-colors">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Export
              </a>
            </div>
          </div>

          <!-- Step 5: LinkedIn Lookup -->
          <div class="bg-gray-50 rounded-lg p-6 border-l-4 border-blue-600">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <!-- Step Number -->
                <div class="flex items-center justify-center w-8 h-8 bg-blue-600 text-white text-sm font-bold rounded-full">
                  5
                </div>
                
                <!-- Circular Progress -->
                <div class="relative w-16 h-16">
                  <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 32 32">
                    <circle cx="16" cy="16" r="14" stroke="#e5e7eb" stroke-width="2" fill="none"/>
                    <circle cx="16" cy="16" r="14" stroke="#10b981" stroke-width="2" fill="none"
                            stroke-dasharray="{{campaign.linkedin_lookup_progress}} 100"
                            stroke-linecap="round"/>
                  </svg>
                  <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-sm font-semibold text-gray-700">{{campaign.linkedin_lookup_progress}}%</span>
                  </div>
                </div>
                
                <!-- Content -->
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <h3 class="text-lg font-medium text-gray-900">LinkedIn Profile Discovery</h3>
                    <div class="relative group">
                      <svg class="w-4 h-4 text-blue-500 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                      </svg>
                      <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                        Searches for official LinkedIn company pages and employees profiles for all companies using SERP API.
                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                      </div>
                    </div>
                    <div class="relative group">
                      <form method="post" action="{% url 'portal:toggle_linkedin_lookup' %}" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="campaign_id" value="{{ campaign.id }}">
                        <button 
                          type="submit"
                          class="ml-2 px-2 py-1 text-xs rounded {% if campaign.linkedin_lookup_enabled %}bg-green-600 text-white{% else %}bg-gray-400 text-white{% endif %} hover:bg-opacity-80 transition-colors cursor-help">
                          {% if campaign.linkedin_lookup_enabled %}ON{% else %}OFF{% endif %}
                        </button>
                      </form>
                      <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                        Toggle LinkedIn discovery on/off for this campaign. When enabled, the system will search for LinkedIn company pages and employee profiles. Only enable onces the website hunting is completed and all the results have been reviewed. This feature also uses company domain (approved) to maximize the scoring.
                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                      </div>
                    </div>
                  </div>
                  <div id="linkedin-progress-{{ campaign.id }}">
                    {% with stats=campaign.linkedin_lookup_stats %}
                      {% if stats.enabled %}
                        <p class="text-sm text-gray-600 mb-2">{{ stats.completed_lookups }}/{{ stats.total_companies }} processed</p>
                        <div class="flex space-x-4 text-xs text-gray-500">
                          <div class="relative group">
                            <span class="cursor-help">👥 {{ stats.profile_breakdown.employee_found.percentage }}% employees</span>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                              {{ stats.profile_breakdown.employee_found.count }} out of {{ stats.total_companies }} companies have at least one employee LinkedIn profile found
                              <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                            </div>
                          </div>
                          <div class="relative group">
                            <span class="cursor-help">🏢 {{ stats.profile_breakdown.company_found.percentage }}% companies</span>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                              {{ stats.profile_breakdown.company_found.count }} out of {{ stats.total_companies }} companies have their official LinkedIn company page found
                              <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                            </div>
                          </div>
                          <div class="relative group">
                            <span class="cursor-help">✅ {{ stats.profile_breakdown.overall_success.percentage }}% overall</span>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 w-64">
                              {{ stats.profile_breakdown.overall_success.count }} out of {{ stats.total_companies }} companies have at least one LinkedIn profile found (either company page or employee profiles)
                              <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                            </div>
                          </div>
                        </div>
                      {% else %}
                        <p class="text-sm text-gray-500">Disabled - Click ON to enable LinkedIn discovery</p>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              </div>
              
              <!-- Export Button -->
              <a href="{% url 'portal:export_linkedin_finder_csv' campaign.id %}" 
                 class="inline-flex items-center px-3 py-1 bg-white border border-gray-300 text-gray-700 text-xs rounded hover:bg-gray-50 transition-colors">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Export
              </a>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="bg-white shadow-md rounded-lg p-8 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No campaigns yet</h3>
        <p class="text-gray-600 mb-4">Get started by creating your first lead enrichment campaign.</p>
        <a href="{% url 'portal:campaign_create' %}" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors no-underline">
          <span class="mr-2">Create Campaign</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
        </a>
      </div>
    {% endif %}
  </div>
</div>

<!-- Delete Campaign Modal -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
    <div class="p-6">
      <div class="flex items-center justify-center w-12 h-12 mx-auto mb-4 bg-red-100 rounded-full">
        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.732 19c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
      </div>
      <h3 class="text-lg font-medium text-gray-900 text-center mb-4">Delete Campaign</h3>
      <p class="text-gray-600 text-center mb-6">
        Are you sure you want to delete campaign <span id="deleteCampaignName" class="font-medium"></span>? 
        This will permanently delete <span id="deleteCompanyCount" class="font-medium"></span> company numbers and all associated data. 
        <strong>This action cannot be undone.</strong>
      </p>
      <div class="flex justify-end space-x-3">
        <button onclick="hideDeleteModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition-colors">
          Cancel
        </button>
        <button onclick="submitDelete()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
          Delete Campaign
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden Form for Campaign Deletion -->
<form id="deleteForm" method="post" style="display: none;">
  {% csrf_token %}
</form>

<script>
let currentCampaignId = null;

function showDeleteModal(campaignId, campaignName, companyCount) {
  currentCampaignId = campaignId;
  document.getElementById('deleteCampaignName').textContent = campaignName;
  document.getElementById('deleteCompanyCount').textContent = companyCount;
  document.getElementById('deleteModal').classList.remove('hidden');
}

function hideDeleteModal() {
  document.getElementById('deleteModal').classList.add('hidden');
  currentCampaignId = null;
}

function submitDelete() {
  if (currentCampaignId) {
    const form = document.getElementById('deleteForm');
    form.action = `/campaigns/delete/${currentCampaignId}/`;
    form.submit();
  }
}

// Close modal when clicking outside
document.getElementById('deleteModal').addEventListener('click', function(e) {
  if (e.target === this) hideDeleteModal();
});

// Close modal with ESC key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') hideDeleteModal();
});

</script>
{% endblock content %}