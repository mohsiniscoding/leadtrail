{% extends "base.html" %}
{% load i18n %}

{% block title %}
  Create Campaign - LeadTrail
{% endblock title %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <h1 class="text-2xl font-bold text-gray-800 mb-6">Create New Campaign</h1>
  
  {% if has_existing_campaign %}
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
      <div class="flex">
        <div class="ml-3">
          <h3 class="text-sm font-medium text-yellow-800">Campaign Limit Reached</h3>
          <p class="text-sm text-yellow-700 mt-1">
            You can have 1 campaign running at a time, this is to save resources and database calls on Heroku. Please delete your existing campaign before creating a new one.
          </p>
          <div class="mt-3">
            <a href="{% url 'portal:home' %}" class="px-3 py-2 bg-yellow-600 text-white text-sm rounded hover:bg-yellow-700 transition-colors">
              Go to Campaigns
            </a>
          </div>
        </div>
      </div>
    </div>
  {% else %}
  <div class="bg-white shadow-md rounded-lg p-6">
    <form id="campaignForm" method="post" action="{% url 'portal:campaign_create' %}">
      {% csrf_token %}
      
      <div class="mb-6">
        <label for="campaign_name" class="block text-sm font-medium text-gray-700 mb-1">Campaign Name</label>
        <input type="text" id="campaign_name" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      
      <div class="mb-6">
        <label for="company_numbers" class="block text-sm font-medium text-gray-700 mb-1">Company Numbers</label>
        <p class="text-sm text-gray-500 mb-2">Enter company numbers new line separated</p>
        <textarea id="company_numbers" name="company_numbers" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="8144770
13382562
8344272
SC769981"></textarea>
      </div>
      
      <div class="flex justify-between items-center">
        <button type="button" id="sanitizeButton" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Sanitize Numbers</button>
        <button type="submit" id="submitButton" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors hidden">Create Campaign</button>
      </div>
    </form>
  </div>
  {% endif %}
</div>

<!-- Sanitize Result Dialog -->
<div id="sanitizeDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <h3 class="text-lg font-medium text-gray-900 mb-4">Sanitization Results</h3>
    
    <div class="mb-4">
      <p class="text-sm text-gray-700">Valid Numbers: <span id="validCount" class="font-medium">0</span></p>
      <p class="text-sm text-gray-700 mt-1">Invalid Numbers: <span id="invalidCount" class="font-medium">0</span></p>
      <p class="text-sm text-gray-700 mt-1">Duplicates Removed: <span id="duplicatesCount" class="font-medium">0</span></p>
    </div>
    
    <div class="mb-4">
      <h4 class="text-sm font-medium text-gray-900 mb-1">Removed Invalid Numbers:</h4>
      <div id="removedNumbers" class="text-xs bg-gray-100 p-2 rounded max-h-32 overflow-y-auto"></div>
    </div>
    
    <div class="flex justify-end">
      <button id="closeDialog" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">OK</button>
    </div>
  </div>
</div>

{% endblock content %}

{% block inline_javascript %}
{% if not has_existing_campaign %}
<script>
  window.addEventListener('DOMContentLoaded', () => {
    console.log("Script loaded");
    const sanitizeButton = document.getElementById('sanitizeButton');
    const submitButton = document.getElementById('submitButton');
    const companyNumbersTextarea = document.getElementById('company_numbers');
    const sanitizeDialog = document.getElementById('sanitizeDialog');
    const closeDialog = document.getElementById('closeDialog');
    const validCount = document.getElementById('validCount');
    const invalidCount = document.getElementById('invalidCount');
    const removedNumbers = document.getElementById('removedNumbers');
    
    console.log("Sanitize button:", sanitizeButton);
    
    sanitizeButton.addEventListener('click', function() {
      console.log("Sanitize button clicked");
      // Get company numbers from textarea
      const numbers = companyNumbersTextarea.value.split('\n')
        .map(num => num.trim())
        .filter(num => num.length > 0);
      
      // Separate valid and invalid numbers
      const validNumbersWithDuplicates = [];
      const invalidNumbersList = [];
      
      numbers.forEach(number => {
        // Check if number contains only digits (valid)
        if (/^\d+$/.test(number)) {
          validNumbersWithDuplicates.push(number);
        } else {
          invalidNumbersList.push(number);
        }
      });
      
      // Remove duplicates from valid numbers
      const uniqueValidNumbers = [...new Set(validNumbersWithDuplicates)];
      const duplicatesRemoved = validNumbersWithDuplicates.length - uniqueValidNumbers.length;
      
      // Update textarea with only unique valid numbers
      companyNumbersTextarea.value = uniqueValidNumbers.join('\n');
      
      // Update dialog content
      validCount.textContent = uniqueValidNumbers.length;
      invalidCount.textContent = invalidNumbersList.length;
      document.getElementById('duplicatesCount').textContent = duplicatesRemoved;
      removedNumbers.textContent = invalidNumbersList.join(', ');
      
      // Show dialog
      sanitizeDialog.classList.remove('hidden');
      
      // Show submit button if at least one valid number
      if (uniqueValidNumbers.length > 0) {
        submitButton.classList.remove('hidden');
      } else {
        submitButton.classList.add('hidden');
      }
    });
    
    closeDialog.addEventListener('click', function() {
      sanitizeDialog.classList.add('hidden');
    });
  });
</script>
{% endif %}
{% endblock inline_javascript %}
